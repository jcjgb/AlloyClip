/*! AlloyClip 2014-04-27 */
!function(){var a=function(a){console.log("Proxy starts creating Ajax!!");var c=b(),d=a.success,e=a.url,f=a.method,g=a.data,h=[];for(var i in g)h.push(i+"="+g[i]);"GET"==f&&(e+="?"+h.join("&")),c?(c.onreadystatechange=function(){4==this.readyState&&(console.log("Proxy Ajax loaded!!"),d&&d(c.responseText))},c.open(f,e,!1),c.send(JSON.stringify(g)),console.log("Proxy created Ajax done!!method: "+f+"; data: "+JSON.stringify(g)+"----already send")):console.error("Proxy created Ajax Error!!")},b=function(){var a;try{a=new XMLHttpRequest}catch(b){try{a=new ActiveXObject("Msxml2.XMLHTTP")}catch(b){try{a=new ActiveXObject("Microsoft.XMLHTTP")}catch(b){return!1}}}return a},c=function(a,b){var c,d="";for(var e in b)d+="var "+e+" = data."+e+";";a=a.replace(/\s+/g," "),a=d+"var __result = ''; ?>"+a+"<?",a+=" return __result;",a=a.replace(/<\?=([^\?]+)\?>/g,"' + $1 + '").replace(/<\?/gi,"';").replace(/\?>/g,"__result += '");var f=new Function("data",a);return c=f(b)},d=function(a,b){var d=document.getElementById(a),e=d.innerHTML,f=c(e,b),g=document.createElement("div");g.innerHTML=f;for(var h=g.childNodes;h.length>0;)d.parentNode.insertBefore(h[0],d)},e=function(a,b,c,d){var e="",f=0;if("string"==typeof b)switch(f=1,!0){case/^\./.test(b):e="className",b=b.replace(".",""),b=new RegExp(" *"+b+" *");break;case/^\#/.test(b):e="id",b=new RegExp(b.replace("#",""));break;default:b=new RegExp(b),e="tagName"}var g=window.addEventListener?"addEventListener":"attachEvent",c=window.addEventListener?c:"on"+c;a[g](c,function(c){function g(h){if(f){var i;if(i="tagName"==e?h.tagName.toLowerCase():h[e],b.test(i))return void d.call(h,c)}else if(b==h)return void d.call(h,c);h!=a&&h.parentNode!=a&&h.parentNode&&g(h.parentNode)}g(c.srcElement)})},f=function(a,b){if(a.style[b])return a.style[b];var c=getComputedStyle(a);return c.getPropertyValue(b)},g=function(a,b,c,d){function e(){l++;var b=l/f*1e3,e=b/c,i=function(a,b,c,d,e){return b*Math.pow(1-a,3)+3*c*a*Math.pow(1-a,2)+3*d*a*a*(1-a)+e*Math.pow(a,3)},j=i(e,.3,.82,1,1)*c;for(var m in g)a.style[m]="opacity"==m?h[m]+g[m]*j:h[m]+g[m]*j+"px";l==c/1e3*f&&(clearInterval(k),d&&d())}var f=60,g={},h={};for(var i in b){var j=parseInt(this.css(a,i));h[i]=j,g[i]=parseInt(parseInt(b[i])-j)/c}var k,l=0;return k=setInterval(e,1e3/f),{stop:function(){clearInterval(k)}}},h={},i=function(){function a(a,b,c){var d=a+"_"+b;h[d]||(h[d]=[]),h[d].push(c)}return window.addEventListener?function(b,c,d){b.addEventListener(c,d,!1),b.id&&a(b.id,c,d)}:function(b,c,d){b.attachEvent("on"+c,d),b.id&&a(b.id,c,d)}}(),j=(function(){return window.addEventListener?function(a,b,c){a.removeEventListener(b,c,!1)}:function(a,b,c){a.detachEvent("on"+b,c)}}(),{request:a,getTmpl:c,renderTmpl:d,addEvent:e,animate:g,css:f,bind:i});window.AlloyClipTools={Utils:j}}(),function(){var a=window.AlloyClipTools.Utils,b=function(a,b,c){if(c&&"string"!=typeof c){var d=document.createElement(a);for(var e in b)"className"!=e&&"id"!=e?d.setAttribute(e,b[e]):d[e]=b[e];return c&&c.appendChild(d),d}var d=document.createElement(a);return b&&b.appendChild(d),c&&(d.className=c),d},c=function(a,c,d,e){c=c||80,d=d||80,this.defaultWidth=c,this.defaultHeight=d;var f=this;this.el=a,this.setting={},this.status={},this.eventPool={},this.setting.isFixed=e,this.imgBoundInfo={},this.clipInfo={};var g=document.createDocumentFragment(),h=b("div",g,"AlloyClipWapper"),i=b("div",h,"AlloyClipLeftWrapper"),j=b("div",h,"AlloyClipRight"),k=b("div",i,"AlloyClipLeft"),l=b("div",i,"AlloyClipOptionWrapper");this.left=k,this.right=j,this.optionWrapper=l;var m=(b("div",k,"AlloyClipButtonTop"),b("div",k,"AlloyClipButton")),n=b("div",k,"AlloyCanvasWrapper"),o=(b("div",k,"AlloyClipButtonTop"),b("div",k,"AlloyClipMask"));n.id="AlloyCanvasWrapper",n.style.display="none";var p=b("input",document.body,"AlloyClipInputFile");p.style.display="none",p.type="file";var q=b("div",j,"AlloyClipRightTitle"),r=b("div",j,"AlloyClipRightContent"),s=b("div",j,"AlloyClipRightInfo"),t=b("div",j,"AlloyClipSwitchPic"),u=b("div",j,"AlloyClipConfim");u.onclick=function(){for(var a=f.eventPool.ok||[],b=f.psedAIPic.save(),c=0;c<a.length;c++)a[c](b,f.psedAIPic)},q.innerHTML="预览",s.innerHTML=c+"×"+d,u.innerHTML="确定",t.innerHTML="切换图片",s.style.display="none",this.rightInfo=s,this.rightContent=r,this.switchPic=t,j.style.width=c+40+"px",a.appendChild(g),this.hideUploadBox=function(){m.style.display="none"},this.showCanvas=function(a){n.innerHTML="",n.style.display="",n.appendChild(a)},this.showMask=function(){o.style.display="block"},this.hideMask=function(){o.style.display="none"},this.canvasWrapper=n,m.onclick=function(){p.click()},t.onclick=function(){p.click()},p.onchange=function(a){var b=a.target.files[0],c=new FileReader;try{c.readAsDataURL(b)}catch(e){window.console&&console.log("\u672a\u9009\u62e9\u56fe\u7247");}c.onload=function(){var a=new Image;a.onload=function(){f.imgEl=this,f.originAILayer=$AI(this),f.hideUploadBox(),f.showCanvas(this),f.showMask(),f.alterImgPositon(this),f.getRect().init(),f.showClipPic(),u.style.display="block",t.style.display="block",e&&f.fixedInit(),f.getOption()},a.src=this.result}},this.rect=null,this.uid="AlloyClip_"+~~(1e6*Math.random())};c.prototype={constructor:c,fileHandler:function(){this.hideUploadBox(),this.showCanvas()},fixedInit:function(){this.imgEl.style.position="absolute",this.imgEl.style.left=this.imgBoundInfo.offsetLeft+"px",this.imgEl.style.top=this.imgBoundInfo.offsetTop+"px",this.bindFixedEvent()},bindFixedEvent:function(){var b,c,d,e,f=this,g=0;this.left.onmousedown=function(a){b=parseInt(f.imgEl.style.left),c=parseInt(f.imgEl.style.top),d=a.pageX,e=a.pageY,g=1,a.preventDefault()},a.addEvent(window,this.left,"mousemove",function(a){var h,i;if(g){h=a.pageX-d,i=a.pageY-e;var j=b+h,k=c+i;f.imgEl.style.left=~~j+"px",f.imgEl.style.top=~~k+"px",f.getRect().setBackgroundPosition(),f.showClipPic(),a.preventDefault()}}),window.addEventListener("mouseup",function(){g=0});var h=function(a,b){var c=f.imgEl.offsetWidth,d=f.imgEl.offsetHeight,e=a[0],g=a[1],h=e*b,i=g*b,j=h-e,k=i-g,l=parseInt(f.imgEl.style.left)-j,m=parseInt(f.imgEl.style.top)-k,n=c*b,o=d*b;f.imgEl.style.width=~~n+"px",f.imgEl.style.height=~~o+"px",f.imgEl.style.left=~~l+"px",f.imgEl.style.top=~~m+"px",f.imgBoundInfo.width=n,f.imgBoundInfo.height=o,f.getRect().init(),f.showClipPic()};this.left.addEventListener("mousewheel",function(a){if(a.target.className&&"AlloyClipRect"==a.target.className)var b=[a.offsetX+a.target.offsetLeft-f.imgEl.offsetLeft,a.offsetY+a.target.offsetTop-f.imgEl.offsetTop];else var b=[a.offsetX-f.imgEl.offsetLeft,a.offsetY-f.imgEl.offsetTop];a.wheelDeltaY<0?h(b,.8):h(b,1.2)})},alterImgPositon:function(a){var b=a.width,c=a.height;a.style.width="0px",a.style.height="0px";var d,e,f,g,h=a.parentNode.parentNode.offsetWidth,i=a.parentNode.parentNode.offsetHeight,j=b/c;h/i>j?(f=i*j,g=i,a.style.width=~~f+"px",a.style.height="auto",d=~~((h-f)/2),e=0):(a.style.height="auto",a.style.width="100%",g=h/j,f=h,d=0,e=~~((i-g)/2)),this.imgBoundInfo.offsetLeft=a.offsetLeft,this.imgBoundInfo.offsetTop=a.offsetTop,this.imgBoundInfo.width=f,this.imgBoundInfo.height=g},getOption:function(){var c=this;return this.optionEl||function(){c.status.currOper="alterationHandler";var d={},e=b("div",c.optionWrapper,"AlloyClipOptionBar"),f=b("div",c.optionWrapper,"AlloyClipOptionPW"),g=b("ul",e,"AlloyClipNav");g.innerHTML="<li id='alteration'>调节</li><li id='filter'>滤镜</li><li id='border'>边框</li>";var h=b("div",e,"AlloyClipOptionController");if(c.isFixed){var i=b("span",h,"AlloyClipCItem"),j=b("span",h,"AlloyClipCItem");i.innerHTML="+",j.innerHTML="-"}var k=b("span",h,"AlloyClipCItem");k.innerHTML="旋转",k.style.fontSize="14px",k.style.verticalAlign="top",k.style.fontFamily="Microsoft Yahei",k.onclick=function(){c.originAILayer.rotate(90).replace(c.imgEl),c.alterImgPositon(c.imgEl),c.getRect().init(),c.showClipPic()};var l=function(){"filterHandler"!=c.status.currOper&&c.psedAIPic&&(c.currLayer=c.psedAIPic),c.status.currOper="filterHandler",f.innerHTML="";var a=b("ul",f,"AlloyClipFilter"),d=["sketch","lomo","soften","softenFace","purpleStyle","vintage","warmAutumn","rough","softEnhancement"],e=f.offsetHeight,g=.7*e;a.style.paddingTop=~~(.15*e)+"px";for(var h=c.currLayer.width,i=(c.currLayer.height,g/h),j=c.currLayer.clone().scale(i),k=0;k<d.length;k++){var l=d[k],m=b("li",a);j.clone().ps(l).show(m),m.onclick=function(a){return function(){c.psedAIPic=c.currLayer.clone().ps(a).replaceChild(c.rightContent)}}(l)}},m=function(){"borderHandler"!=c.status.currOper&&c.psedAIPic&&(c.currLayer=c.psedAIPic),c.status.currOper="borderHandler",f.innerHTML="";for(var a=b("ul",f,"AlloyClipFilter AlloyClipBorder"),d=["border/border1.png","border/border2.png"],e=50,g=(c.currLayer.width,c.currLayer.height,c.currLayer.clone().scaleTo(null,e)),h=0;h<d.length;h++){var i=d[h],j=b("li",a),k=new Image;k.onload=function(a){return function(){var b=$AI(this);b.scaleTo(g.width,g.height),g.clone().add(b.clone()).show(a)}}(j),k.src=i,j.onclick=function(a){return function(){var b=new Image;b.onload=function(){return function(){var a=$AI(this);a.scaleTo(c.currLayer.width,c.currLayer.height),c.psedAIPic=c.currLayer.clone().add(a.clone()).replaceChild(c.rightContent)}}(j),b.src=a}}(i)}},n=function(){"alterationHandler"!=c.status.currOper&&c.psedAIPic&&(c.currLayer=c.psedAIPic),c.status.currOper="alterationHandler",f.innerHTML="";var a=b("ul",f,"AlloyClipFilter AlloyClipAlter"),d=function(){},e=c.getScrollBar(160,.5,"色　相","apH",d),g=c.getScrollBar(160,.5,"饱和度","apS",d),h=c.getScrollBar(160,.5,"亮　度","apI",d),i=c.getScrollBar(160,.5,"对比度","apD",d);a.appendChild(e),a.appendChild(g),a.appendChild(h),a.appendChild(i),c.status.currOperation="Alteration",c.status.toolBarValue={Alteration:[.5,.5,.5,.5]}};return a.addEvent(g,"li","click",function(a){switch(this.id){case"filter":l(a);break;case"border":m(a);break;case"alteration":n(a)}}),c.bindScrollBarEvent(),e.appendChild(c.switchPic),c.optionEl=d,d.doCurrOptionPro=function(){switch(c.status.currOper){case"filterHandler":l();break;case"borderHandler":m();break;case"alterationHandler":n()}},d}()},getScrollBar:function(a,c,d,e){var a=a||200,c=c||.5,d=d||"",f=this.uid,g=document.createElement("li");g.className="apScrollBarWrapper";var h=b("div",{className:"apBarTitle"},g),i=b("div",{className:"apBarContent"},g),j=b("div",{className:"apBarLineLeft"},i),k=b("div",{className:"apBarScrollEl","data-uid":f,id:e},i),l=b("div",{className:"apBarLineRight"},i),m=30;return h.innerHTML=d,j.style.width=c*a+"px",l.style.width=(1-c)*a+"px",k.style.left=c*a-m/2+"px",g},bindScrollBarEvent:function(a){var b=this,c=0,d=0,e=0,f=0;originTop=0;var g,h,i,a=a||160,j=j||30,k=.5;document.body.addEventListener("mousedown",function(a){var j=a.target;if("apBarScrollEl"==j.className){var k=j.getAttribute("data-uid");if(k!=b.uid)return;c=1,g=j,h=g.parentNode.childNodes[0],i=g.parentNode.childNodes[2],d=a.pageX,e=a.pageY,f=j.offsetLeft,originTop=j.offsetTop}a.preventDefault()},!1),document.body.addEventListener("mouseup",function(){if(c){var a=g.id,d=b.currLayer.clone();if("Alteration"==b.status.currOperation){"apH"==a?b.status.toolBarValue.Alteration[0]=k:"apS"==a?b.status.toolBarValue.Alteration[1]=k:"apI"==a?b.status.toolBarValue.Alteration[2]=k:"apD"==a&&(b.status.toolBarValue.Alteration[3]=k),c=0;var e=b.status.toolBarValue.Alteration;if("apD"==a){var f=e[3];f=100*(f-.5),d.act("brightness",0,f).replaceChild(b.rightContent)}else{var h=e[0],i=e[1],j=e[2];h=360*(h-.5),i=100*(i-.5),j=100*(j-.5),d.act("setHSI",h,i,j,0).replaceChild(b.rightContent)}}}c=0},!1),document.body.addEventListener("mousemove",function(b){b.target;if(c){var e=b.pageX,l=(b.pageY,e-d),m=f+l;if(k=(m+j/2)/a,k>1||0>k)return;g.style.left=m+"px",h.style.width=a*k+"px",i.style.width=a*(1-k)+"px",b.preventDefault()}},!1)},getRect:function(){var c=this;return this.rect||function(){var d=b("div",c.left,"AlloyClipRect");d.style.width=c.defaultWidth+"px",d.style.height=c.defaultHeight+"px";var e,f,g,h,i,j,k,l=b("div",d,"AlloyBgImgWrapper"),m=b("img",l,"AlloyBgImg"),n=function(){d.style.width=c.defaultWidth+"px",d.style.height=c.defaultHeight+"px";var a=c.left.offsetWidth,b=c.left.offsetHeight,e=~~((a-c.defaultWidth)/2)+"px",f=~~((b-c.defaultHeight)/2)+"px";d.style.left=e,d.style.top=f},o=d.offsetWidth,p=d.offsetHeight,q=o/p,r=[{position:"top left",left:"0px",top:"0px"},{position:"top right",right:"0px",top:"0px"},{position:"bottom left",bottom:"0px",left:"0px"},{position:"bottom right",bottom:"0px",right:"0px"}],s=0,t=0,u=function(){var a=c.imgEl.offsetLeft,b=c.imgEl.offsetTop,e=~~(d.offsetLeft-a)+2,f=~~(d.offsetTop-b)+2;m.style.left=-e+"px",m.style.top=-f+"px",c.clipInfo.left=e,c.clipInfo.top=f,c.clipInfo.width=d.offsetWidth,c.clipInfo.height=d.offsetHeight},v=function(a,b,e,f){_left=void 0!=a?a:i,_top=void 0!=b?b:j;var k=e||g,l=f||h,m=~~(c.imgBoundInfo.offsetLeft+c.imgBoundInfo.width),n=~~(c.imgBoundInfo.offsetTop+c.imgBoundInfo.height);if(e){if(void 0!=a&void 0!=b){var o=i+g,p=j+h;if(_top<c.imgBoundInfo.offsetTop){var r=c.imgBoundInfo.offsetTop,s=p-c.imgBoundInfo.offsetTop,t=s*q,u=o-t;return u<c.imgBoundInfo.offsetLeft&&(t=o-c.imgBoundInfo.offsetLeft,s=t/q,r=p-s,u=o-t),d.style.top=~~r+"px",d.style.left=~~u+"px",d.style.width=~~t+"px",void(d.style.height=~~s+"px")}if(o-k<c.imgBoundInfo.offsetLeft){var t=o-c.imgBoundInfo.offsetLeft,s=t/q,r=p-s,u=o-t;return r<c.imgBoundInfo.offsetHeight&&(r=c.imgBoundInfo.offsetHeight,s=p-r,t=s*q,u=o-t),d.style.top=~~r+"px",d.style.left=~~u+"px",d.style.width=~~t+"px",void(d.style.height=~~s+"px")}}else if(void 0!=a){var o=i+g,p=j;if(_top+l>n){var s=n-_top,t=s*q,u=o-t;return u<c.imgBoundInfo.offsetLeft&&(u=c.imgBoundInfo.offsetLeft,t=o-u,s=t/q),d.style.left=~~u+"px",d.style.width=~~t+"px",void(d.style.height=~~s+"px")}if(_left<c.imgBoundInfo.offsetLeft){var u=c.imgBoundInfo.offsetLeft,t=o-c.imgBoundInfo.offsetLeft,s=t/q;_top+s>n&&(s=n-_top,t=s*q),d.style.left=~~u+"px",d.style.width=~~t+"px",d.style.height=~~s+"px"}}else if(void 0!=b){var o=i,p=j+h;if(_top<c.imgBoundInfo.offsetTop){var r=c.imgBoundInfo.offsetTop,s=p-c.imgBoundInfo.offsetTop,t=s*q;return _left+t>m&&(t=m-_left,s=t/q,r=p-s),d.style.top=~~r+"px",d.style.width=~~t+"px",void(d.style.height=~~s+"px")}if(o+k>m){var t=m-o,s=t/q,r=p-s;return r<c.imgBoundInfo.offsetHeight&&(r=c.imgBoundInfo.offsetHeight,s=p-r,t=s*q),d.style.top=~~r+"px",d.style.width=~~t+"px",void(d.style.height=~~s+"px")}}else if(_left+k>m){var t=m-_left,s=t/q;_top+s>n&&(s=n-_top,t=s*q),d.style.width=~~t+"px",d.style.height=~~s+"px"}else if(_top+l>n){var s=n-_top,t=s*q;_left+t>m&&(t=m-_left,s=t/q),d.style.width=~~t+"px",d.style.height=~~s+"px"}}else _left<c.imgBoundInfo.offsetLeft&&(d.style.left=~~c.imgBoundInfo.offsetLeft+"px"),_top<c.imgBoundInfo.offsetTop&&(d.style.top=~~c.imgBoundInfo.offsetTop+"px"),_left+k>m&&(d.style.left=~~(m-k)+"px"),_top+l>n&&(d.style.top=~~(n-l)+"px")},w=function(){m.src=c.imgEl.src,m.style.width=c.imgBoundInfo.width+"px",m.style.height=c.imgBoundInfo.height+"px",u()};if(c.setting.isFixed||a.addEvent(window,d,"mousedown",function(a){s=1,e=a.pageX,f=a.pageY,i=d.offsetLeft,j=d.offsetTop,g=d.offsetWidth,h=d.offsetHeight}),!c.setting.isFixed)for(var x=0;x<r.length;x++){for(var y=b("div",d,"AlloyClipControl"),z=["left","right","top","bottom"],A=0;A<z.length;A++){var B=z[A];r[x][B]&&(y.style[B]=~~r[x][B]-10+"px")}a.addEvent(c.left,y,"mousedown",function(a){return function(b){t=1,d.style.webkitTransformOrigin=r[r.length-1-a].position,e=b.pageX,f=b.pageY,g=d.offsetWidth,h=d.offsetHeight,i=d.offsetLeft,j=d.offsetTop,k=a,b.stopPropagation()}}(x))}return window.addEventListener("mousemove",function(a){var b=a.pageX,c=a.pageY;if(t){a.preventDefault();var h=b-e,l=h/q;if(3==k){var m=g+h,n=m/q;if(0>m||0>n)return;d.style.width=m+"px",d.style.height=n+"px",v(null,null,m,n)}else if(2==k){var m=-h+g,n=m/q,o=i+h;if(0>m||0>n)return;d.style.width=m+"px",d.style.height=n+"px",d.style.left=o+"px",v(o,null,m,n)}else if(1==k){var m=g+h,n=m/q,p=j-l;if(0>m||0>n)return;d.style.width=m+"px",d.style.height=n+"px",d.style.top=p+"px",v(null,p,m,n)}else if(0==k){var m=g-h,n=m/q,o=i+h,p=j+l;if(0>m||0>n)return;d.style.width=m+"px",d.style.height=n+"px",d.style.left=o+"px",d.style.top=p+"px",v(o,p,m,n)}u()}else if(s){a.preventDefault();var h=b-e,r=c-f,o=i+h,p=j+r;d.style.left=o+"px",d.style.top=p+"px",v(o,p),u()}}),window.addEventListener("mouseup",function(){(t||s)&&c.showClipPic(),t=0,s=0}),c.rect=d,d.init=function(){n(),w()},d.setBackgroundPosition=u,d}()},showClipPic:function(){var a=$AI(this.imgEl),b=this.clipInfo,c=this.defaultWidth/b.width,d=this.defaultHeight/b.height;this.currLayer=a.clip(b.left,b.top,b.width,b.height).scale(c,d).replaceChild(this.rightContent),this.psedAIPic=this.currLayer,this.rightInfo.style.display="",this.getOption().doCurrOptionPro()},addEventListener:function(a,b){this.eventPool[a]||(this.eventPool[a]=[]),this.eventPool[a].push(b)}};var d=function(a,b,d,e){if("object"!=typeof a){for(var f=document.querySelectorAll(a),g={},h=[],i=0;i<f.length;i++)h.push(new c(f[i],b,d,e));return g.ok=function(a){for(var b=0;b<h.length;b++)h[b].addEventListener("ok",function(b,c){a&&a(b,c)})},g}};$AC=AlloyClip=d}();